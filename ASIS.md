# AS-IS λ¶„μ„: ChatMock

> λ¶„μ„ μ‹μ : 2026-02-13 | μ΄ μ½”λ“: ~4,400 LOC (Python)

---

## 1. ν”„λ΅μ νΈ κ°μ”

ChatGPT μ λ£ κ³„μ •(Plus/Pro)μ„ μ΄μ©ν•΄ OpenAI/Ollama νΈν™ λ΅μ»¬ API μ„λ²„λ¥Ό κµ¬λ™ν•λ” Flask μ•±.
ChatGPT Codex λ°±μ—”λ“(`chatgpt.com/backend-api/codex/responses`)λ΅ μ”μ²­μ„ ν”„λ΅μ‹ν•λ‹¤.

| ν•­λ© | κ°’ |
|------|-----|
| Python | `>=3.13` |
| ν”„λ μ„μ›ν¬ | Flask 3.1.1 |
| HTTP ν΄λΌμ΄μ–ΈνΈ | requests 2.32.5 |
| CLI | Click 8.2.1 |
| ν…μ¤νΈ | **μ—†μ** |
| λ¦°ν„°/ν¬λ§¤ν„° | **μ—†μ** |
| νƒ€μ…μ²΄ν¬ | **μ—†μ** |
| CI/CD | **μ—†μ** |

---

## 2. λ¨λ“ κ·λ¨ λ° λ³µμ΅λ„

| νμΌ | LOC | μ—­ν•  | λ³µμ΅λ„ |
|------|-----|------|--------|
| `utils.py` | 875 | μΈμ¦, SSE λ²μ—­, λ©”μ‹μ§€ λ³€ν™ | π”΄ λ§¤μ° λ†’μ |
| `routes_ollama.py` | 612 | Ollama νΈν™ μ—”λ“ν¬μΈνΈ | π”΄ λ†’μ |
| `routes_openai.py` | 555 | OpenAI νΈν™ μ—”λ“ν¬μΈνΈ | π”΄ λ†’μ |
| `cli.py` | 416 | CLI λ…λ Ήμ–΄ | π΅ λ³΄ν†µ |
| `oauth.py` | 340 | OAuth PKCE μΈμ¦ | π΅ λ³΄ν†µ |
| `limits.py` | 200 | Rate limit μ¶”μ  | πΆ λ‚®μ |
| `upstream.py` | 152 | μ—…μ¤νΈλ¦Ό μ”μ²­ | πΆ λ‚®μ |
| `transform.py` | 149 | Ollamaβ†”OpenAI λ³€ν™ | πΆ λ‚®μ |
| `reasoning.py` | 123 | μ¶”λ΅  μ„¤μ • μ²λ¦¬ | πΆ λ‚®μ |
| `session.py` | 89 | μ„Έμ… ID κ΄€λ¦¬ | πΆ λ‚®μ |
| `app.py` | 50 | Flask μ•± ν©ν† λ¦¬ | πΆ λ‚®μ |
| `config.py` | 48 | μ„¤μ •/ν”„λ΅¬ν”„νΈ λ΅λ”© | πΆ λ‚®μ |
| `models.py` | 26 | λ°μ΄ν„°ν΄λμ¤ | πΆ λ‚®μ |
| `http.py` | 24 | CORS/μ—λ¬ μ ν‹Έ | πΆ λ‚®μ |

---

## 3. λ¨λ“ μμ΅΄μ„± κ·Έλν”„

```
cli.py β”€β”€β†’ app.py β”€β”€β†’ routes_openai.py β”€β”€β†’ upstream.py β”€β”€β†’ utils.py
       β”‚           β”‚                   β”‚               β”‚
       β”‚           β””β†’ routes_ollama.pyβ”€β”¤               β””β†’ config.py
       β”‚                               β”‚
       β””β†’ oauth.py β”€β”€β†’ models.py       β”β†’ reasoning.py
       β”‚           β””β†’ utils.py         β”β†’ limits.py
       β””β†’ limits.py                    β”β†’ http.py
       β””β†’ utils.py                     β””β†’ transform.py (ollama only)
                                            β””β†’ session.py
```

**μν™ μμ΅΄ μ—†μ** β€” μμ΅΄ λ°©ν–¥μ΄ μΌκ΄€μ μ΄λ‹¤.

---

## 4. API μ—”λ“ν¬μΈνΈ μ „μ²΄ λ©λ΅

### OpenAI νΈν™ (`openai_bp`)

| λ©”μ„λ“ | κ²½λ΅ | μ„¤λ… |
|--------|------|------|
| POST | `/v1/chat/completions` | μ±„ν… μ™„μ„± (μ¤νΈλ¦Ό/λΉ„μ¤νΈλ¦Ό) |
| POST | `/v1/completions` | ν…μ¤νΈ μ™„μ„± (λ κ±°μ‹) |
| GET | `/v1/models` | λ¨λΈ λ©λ΅ |

### Ollama νΈν™ (`ollama_bp`)

| λ©”μ„λ“ | κ²½λ΅ | μ„¤λ… |
|--------|------|------|
| GET | `/api/version` | λ²„μ „ μ •λ³΄ (κ°€μ§ 0.12.10 λ°ν™) |
| GET | `/api/tags` | λ¨λΈ νƒκ·Έ λ©λ΅ |
| POST | `/api/show` | λ¨λΈ μƒμ„Έ (ν•λ“μ½”λ”©λ κ°€μ§ λ©”νƒ€λ°μ΄ν„°) |
| POST | `/api/chat` | μ±„ν… (μ¤νΈλ¦Ό/λΉ„μ¤νΈλ¦Ό) |

### μ‹μ¤ν…

| λ©”μ„λ“ | κ²½λ΅ | μ„¤λ… |
|--------|------|------|
| GET | `/` | ν—¬μ¤μ²΄ν¬ |
| GET | `/health` | ν—¬μ¤μ²΄ν¬ |

---

## 5. μ”μ²­ νλ¦„ (λ°μ΄ν„° νμ΄ν”„λΌμΈ)

```
[ν΄λΌμ΄μ–ΈνΈ μ”μ²­]
     β”‚
     β–Ό
routes_openai.py / routes_ollama.py
     β”‚  1. JSON νμ‹± + κ²€μ¦
     β”‚  2. λ¨λΈλ… μ •κ·ν™” (upstream.normalize_model_name)
     β”‚  3. system λ©”μ‹μ§€ β†’ user λ©”μ‹μ§€ λ³€ν™
     β”‚  4. λ©”μ‹μ§€ λ³€ν™ (utils.convert_chat_messages_to_responses_input)
     β”‚  5. λ„κµ¬ λ³€ν™ (utils.convert_tools_chat_to_responses)
     β”‚  6. μ¶”λ΅  νλΌλ―Έν„° λΉλ“ (reasoning.build_reasoning_param)
     β”‚
     β–Ό
upstream.start_upstream_request()
     β”‚  1. ChatGPT ν† ν° λ΅λ“ + μλ™ κ°±μ‹  (utils.load_chatgpt_tokens)
     β”‚  2. μ„Έμ… ID κ²°μ • (session.ensure_session_id)
     β”‚  3. POST β†’ chatgpt.com/backend-api/codex/responses (stream=True)
     β”‚
     β–Ό
[μ‘λ‹µ μ²λ¦¬]
     β”‚  μ¤νΈλ¦Ό: utils.sse_translate_chat() / sse_translate_text()
     β”‚  λΉ„μ¤νΈλ¦Ό: λΌμ°νΈ ν•Έλ“¤λ¬ λ‚΄μ—μ„ μ§μ ‘ μ΄λ²¤νΈ λ„μ 
     β”‚
     β–Ό
[ν΄λΌμ΄μ–ΈνΈ μ‘λ‹µ] (OpenAI λλ” Ollama ν¬λ§·)
```

---

## 6. λ³΄μ• λ¶„μ„

### μΈμ¦/μΈκ°€

| ν•­λ© | ν„ν™© | μ„ν—λ„ |
|------|------|--------|
| μμ‹  μ”μ²­ μΈμ¦ | **μ—†μ** β€” API ν‚¤ κ²€μ¦ μ—†μ΄ λ¨λ“  μ”μ²­ μλ½ | π”΄ λ†’μ |
| ChatGPT ν† ν° μ €μ¥ | `~/.chatgpt-local/auth.json` νμΌ, 0o600 κ¶ν• | π΅ μ μ  |
| ν† ν° μλ™ κ°±μ‹  | JWT λ§λ£ 5λ¶„ μ „ μλ™ λ¦¬ν”„λ μ‹ | πΆ μ–‘νΈ |
| CORS | **λ¨λ“  Origin ν—μ©** (μ”μ²­ Origin μ—μ½”λ°±) | π”΄ λ†’μ |

### ν•λ“μ½”λ”©λ κ°’

| μ„μΉ | κ°’ | λΉ„κ³  |
|------|-----|------|
| `config.py:8` | `app_EMoamEEZ73f0CkXaXp7hrann` | OAuth Client ID (ν™κ²½λ³€μλ΅ μ¤λ²„λΌμ΄λ“ κ°€λ¥) |
| `config.py:9` | `https://auth.openai.com` | OAuth Issuer |
| `config.py:12` | `https://chatgpt.com/backend-api/codex/responses` | μ—…μ¤νΈλ¦Ό URL |
| `oauth.py:21` | ν¬νΈ `1455` | OAuth μ½λ°± ν¬νΈ |

---

## 7. μ½”λ“ ν’μ§ λ¬Έμ μ 

### π”΄ μ‹¬κ° (Critical)

#### 7.1 `utils.py`κ°€ God Module
- **875μ¤„**μ— μ™„μ „ν λ‹¤λ¥Έ κ΄€μ‹¬μ‚¬ νΌμ¬:
  - μΈμ¦ λ΅μ§ (ν† ν° λ΅λ“/κ°±μ‹ /μ €μ¥)
  - SSE μ¤νΈλ¦Ό λ²μ—­ (2κ° ν•¨μ, κ° ~250μ¤„)
  - λ©”μ‹μ§€ ν¬λ§· λ³€ν™
  - PKCE μƒμ„±
  - JWT νμ‹±
- SSE λ²μ—­ ν•¨μ(`sse_translate_chat`)λ” λ‹¨μΌ ν•¨μκ°€ **~410μ¤„** β€” ν”„λ΅μ νΈμ—μ„ κ°€μ¥ ν° ν•¨μ

#### 7.2 λΌμ°νΈ ν•Έλ“¤λ¬μ— λΉ„μ¦λ‹μ¤ λ΅μ§ νΌμ¬
- `routes_openai.py:chat_completions()` β€” **~300μ¤„** λ‹¨μΌ ν•¨μ
  - JSON νμ‹±, κ²€μ¦, λ³€ν™, μ—…μ¤νΈλ¦Ό νΈμ¶, μ—λ¬ μ²λ¦¬, μ¤νΈλ¦Ό/λΉ„μ¤νΈλ¦Ό λ¶„κΈ° λ¨λ‘ ν¬ν•¨
- `routes_ollama.py:ollama_chat()` β€” **~400μ¤„** λ‹¨μΌ ν•¨μ
  - μΈλΌμΈ μ¤νΈλ¦Ό μ λ„λ μ΄ν„° `_gen()`μ΄ ~140μ¤„

#### 7.3 μ½”λ“ μ¤‘λ³µ
- `_log_json()` β€” `routes_openai.py:30`, `routes_ollama.py:26`, `upstream.py:17`μ— **λ™μΌ ν•¨μ 3λ²**
- `_wrap_stream_logging()` β€” `routes_openai.py:40`, `routes_ollama.py:36`μ— **λ™μΌ ν•¨μ 2λ²**
- `_instructions_for_model()` β€” `routes_openai.py:60`, `routes_ollama.py:72`μ— **λ™μΌ ν•¨μ 2λ²**
- `_extract_usage()` β€” `routes_openai.py:279`, `routes_openai.py:473`, `utils.py:424`, `utils.py:796`μ— **4λ²**
- λΉ„μ¤νΈλ¦Ό SSE νμ‹± λ΅μ§ β€” `routes_openai.py:290-337`, `routes_ollama.py:547-587`μ— κ±°μ λ™μΌν• λ£¨ν”„ **2λ²**
- `_parse_iso8601()` β€” `utils.py:354`μ™€ `limits.py:153`μ— μ μ‚¬ κµ¬ν„ **2λ²**

### π΅ μ£Όμ (Warning)

#### 7.4 ν…μ¤νΈ λ¶€μ¬
- ν…μ¤νΈ νμΌ, ν…μ¤νΈ ν”„λ μ„μ›ν¬, ν…μ¤νΈ μ„¤μ •μ΄ ν•λ‚λ„ μ—†μ
- SSE λ²μ—­, λ©”μ‹μ§€ λ³€ν™ κ°™μ€ ν•µμ‹¬ λ΅μ§μ΄ κ²€μ¦ μ—†μ΄ λ™μ‘
- νκ·€ λ°©μ§€ μλ‹¨ μ „λ¬΄

#### 7.5 Ollama λΌμ°νΈμ Fake λ°μ΄ν„°
- `routes_ollama.py:81-88` β€” `_OLLAMA_FAKE_EVAL` ν•λ“μ½”λ”©λ κ°€μ§ μ„±λ¥ λ©”νΈλ¦­
- `routes_ollama.py:143-154` β€” λ¨λ“  λ¨λΈμ— λ™μΌν• κ°€μ§ λ©”νƒ€λ°μ΄ν„° (8B, Q4_0, llama family)
- `routes_ollama.py:185-201` β€” `/api/show`μ— ν•λ“μ½”λ”©λ λ¨λΈ μ •λ³΄

#### 7.6 μ—λ¬ μ²λ¦¬ λ¶μΌμΉ
- OpenAI λΌμ°νΈ: `{"error": {"message": "..."}}` ν•μ‹
- Ollama λΌμ°νΈ: `{"error": "..."}` ν•μ‹ (λ¬Έμμ—΄)
- μΌλ¶€λ” `jsonify(err), status_code`, μΌλ¶€λ” `make_response(jsonify(err), code)`

#### 7.7 μ„¤μ • μ ‘κ·Ό ν¨ν„΄ λ¶μΌμΉ
- λ€λ¶€λ¶„: `current_app.config.get("KEY")` μ§μ ‘ μ ‘κ·Ό
- μΌλ¶€: ν•¨μ νλΌλ―Έν„°λ΅ μ „λ‹¬
- `upstream.py:122-126` β€” try/exceptλ΅ verbose μ„¤μ • μ ‘κ·Ό (Flask μ»¨ν…μ¤νΈ λ°– νΈμ¶ λ€λΉ„)

### πΆ κ΄€μ°° (Info)

#### 7.8 λ¨λΈ λ©λ΅ μ¤‘λ³µ κ΄€λ¦¬
- `routes_openai.py:534-544` β€” `/v1/models`μ λ¨λΈ λ©λ΅ (λ°μ΄ν„° κΈ°λ°, ν™•μ¥ μ‰¬μ›€)
- `routes_ollama.py:96-136` β€” `/api/tags`μ λ¨λΈ λ©λ΅ (ν•λ“μ½”λ”©, reasoning variant μλ™ λ‚μ—΄)
- λ‘ κ³³μ λ¨λΈ λ©λ΅μ΄ λ™κΈ°ν™” λ³΄μ¥ μ—†μ

#### 7.9 OAuth ν•Έλ“¤λ¬ λ‚΄ λ΅μ§ μ¤‘λ³µ
- `OAuthHTTPServer.maybe_obtain_api_key()` β€” `oauth.py:128-183`
- `OAuthHandler._maybe_obtain_api_key()` β€” `oauth.py:287-340`
- κ±°μ λ™μΌν• API ν‚¤ κµν™ λ΅μ§μ΄ μ„λ²„/ν•Έλ“¤λ¬ μ–‘μ½μ— μ΅΄μ¬

#### 7.10 μ„Έμ… κ΄€λ¦¬μ μΈλ©”λ¨λ¦¬ ν•κ³„
- `session.py` β€” `_FINGERPRINT_TO_UUID` dictμ— μµλ€ 10,000κ° μ €μ¥
- μ„λ²„ μ¬μ‹μ‘ μ‹ λ¨λ“  μ„Έμ… μ μ‹¤
- λ‹¨μΌ ν”„λ΅μ„Έμ¤ μ „μ  (λ©€ν‹° μ›μ»¤ λ¶κ°€)

---

## 8. μ•„ν‚¤ν…μ² κ°•μ 

| ν•­λ© | μ„¤λ… |
|------|------|
| μν™ μμ΅΄ μ—†μ | λ¨λ“ κ°„ μμ΅΄ λ°©ν–¥μ΄ κΉ”λ”ν•κ³  μΌλ°©ν–¥ |
| μ•± ν©ν† λ¦¬ ν¨ν„΄ | `create_app()`μΌλ΅ μ„¤μ • μ£Όμ…, Blueprint λ¶„λ¦¬ |
| ν† ν° μλ™ κ°±μ‹  | JWT λ§λ£ μ „ μλ™ λ¦¬ν”„λ μ‹, νμΌ μμ†ν™” |
| μ¤νΈλ¦Ό μ§€μ› | SSE μ‹¤μ‹κ°„ μ¤νΈλ¦¬λ° + λΉ„μ¤νΈλ¦Ό λ¨λ“ λ™μ‹ μ§€μ› |
| μ¶”λ΅  μ„¤μ • λ¶„λ¦¬ | `reasoning.py`μ— μ¶”λ΅  κ΄€λ ¨ λ΅μ§ κΉ”λ”ν•κ² λ¶„λ¦¬ |
| Rate limit μ¶”μ  | μ—…μ¤νΈλ¦Ό μ‘λ‹µ ν—¤λ”μ—μ„ μ‚¬μ©λ‰ νμ‹±/μ €μ¥ |
| ν”„λ΅¬ν”„νΈ μ™Έλ¶€ν™” | `prompt.md`, `prompt_gpt5_codex.md`λ΅ μ‹μ¤ν… ν”„λ΅¬ν”„νΈ λ¶„λ¦¬ |

---

## 9. κΈ°μ  λ¶€μ±„ μ”μ•½

| μΉ΄ν…κ³ λ¦¬ | κ±΄μ | μ‹¬κ°λ„ |
|----------|------|--------|
| God Module (utils.py) | 1 | π”΄ |
| ν•¨μ μ¤‘λ³µ | 6+ | π”΄ |
| God Function (300μ¤„+ ν•Έλ“¤λ¬) | 3 | π”΄ |
| ν…μ¤νΈ λ¶€μ¬ | μ „μ²΄ | π΅ |
| λ³΄μ• (μΈμ¦ μ—†μ, CORS μ¤ν”) | 2 | π΅ |
| Fake/ν•λ“μ½”λ”© λ°μ΄ν„° | 3κ³³ | π΅ |
| μ—λ¬ μ‘λ‹µ ν•μ‹ λ¶μΌμΉ | μ „μ²΄ | π΅ |
| μΈλ©”λ¨λ¦¬ μ„Έμ… | 1 | πΆ |

---

## 10. κ°μ„  κ¶μ¥μ‚¬ν•­ (μ°μ„ μμ„)

### P0 β€” μ¦‰μ‹

1. **`utils.py` λ¶„ν• ** β†’ `auth.py`, `sse.py`, `messages.py`, `crypto.py`
2. **μ¤‘λ³µ ν•¨μ ν†µν•©** β†’ `_log_json`, `_wrap_stream_logging`, `_instructions_for_model`, `_extract_usage`λ¥Ό κ³µμ  λ¨λ“λ΅
3. **λΌμ°νΈ ν•Έλ“¤λ¬ λ¦¬ν©ν† λ§** β†’ λΉ„μ¦λ‹μ¤ λ΅μ§μ„ μ„λΉ„μ¤ λ μ΄μ–΄λ΅ μ¶”μ¶

### P1 β€” λ‹¨κΈ°

4. **ν…μ¤νΈ λ„μ…** β†’ μµμ†ν• SSE λ²μ—­, λ©”μ‹μ§€ λ³€ν™, μ¶”λ΅  νλΌλ―Έν„° λΉλ“μ— λ‹¨μ„ ν…μ¤νΈ
5. **μ—λ¬ μ‘λ‹µ ν•μ‹ ν†µμΌ** β†’ OpenAI/Ollama λ¨λ‘ μΌκ΄€λ κµ¬μ΅°
6. **λ¨λΈ λ©λ΅ λ‹¨μΌ μ†μ¤** β†’ ν• κ³³μ—μ„ μ •μ, μ–‘μ½ λΌμ°νΈμ—μ„ μ°Έμ΅°

### P2 β€” μ¤‘κΈ°

7. **μμ‹  μ”μ²­ μΈμ¦ μ¶”κ°€** β†’ μ„ νƒμ  API ν‚¤ κ²€μ¦
8. **CORS μ ν•** β†’ μ„¤μ • κ°€λ¥ν• ν—μ© Origin λ©λ΅
9. **λ¦°ν„°/ν¬λ§¤ν„° λ„μ…** β†’ ruff λλ” black + isort μ„¤μ •
10. **CI νμ΄ν”„λΌμΈ** β†’ GitHub Actionsλ΅ λ¦°νΈ + ν…μ¤νΈ μλ™ν™”
